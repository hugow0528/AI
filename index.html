<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Subject AI Learning Platform</title>
    <link rel="icon" sizes="192x192" href="https://hugo_wong.pyscriptapps.com/ict-ai-v4-3/latest/logo.jpg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e6f0fa, #f0f4f8);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 15px;
            transition: background 0.3s;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #e0e0e0;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            padding: 30px;
            animation: fadeIn 0.7s ease-in;
            min-height: calc(100vh - 30px);
            position: relative;
            transition: background 0.3s, color 0.3s;
        }

        .dark-mode .container {
            background: #2d3748;
            color: #e0e0e0;
        }

        .auth-container {
            max-width: 500px;
            text-align: center;
            background: #ffffff;
            padding: 40px;
            border-radius: 12px;
        }

        .dark-mode .auth-container {
            background: #3a4655;
        }

        .auth-container h1 {
            color: #1a3c6d;
            font-size: clamp(28px, 5vw, 32px);
            margin-bottom: 30px;
            font-weight: 700;
        }

        .dark-mode .auth-container h1 {
            color: #60a5fa;
        }

        .auth-container input {
            width: 100%;
            padding: 14px;
            margin: 12px 0;
            border: 1px solid #d1d9e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .dark-mode .auth-container input {
            background: #4a5568;
            border-color: #718096;
            color: #e0e0e0;
        }

        .auth-container input:focus {
            border-color: #007bff;
            box-shadow: 0 0 6px rgba(0, 123, 255, 0.4);
            outline: none;
        }

        .auth-container button {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s, transform 0.2s;
        }

        .auth-container button:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        #auth-error {
            color: #dc3545;
            margin-top: 12px;
            font-size: 14px;
        }

        .cover-container h1 {
            color: #1a3c6d;
            font-size: clamp(32px, 6vw, 40px);
            margin-bottom: 25px;
            font-weight: 700;
            text-align: center;
        }

        .dark-mode .cover-container h1 {
            color: #60a5fa;
        }

        .subject-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .subject-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            text-align: center;
        }

        .dark-mode .subject-card {
            background: #4a5568;
        }

        .subject-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .subject-card h2 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .dark-mode .subject-card h2 {
            color: #e0e0e0;
        }

        .ai-list-container {
            text-align: center;
        }

        .ai-list-container h1 {
            color: #1a3c6d;
            font-size: clamp(30px, 5vw, 36px);
            margin-bottom: 25px;
        }

        .dark-mode .ai-list-container h1 {
            color: #60a5fa;
        }

        .ai-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .ai-option {
            background: #007bff;
            color: #fff;
            padding: 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s, transform 0.2s;
            text-align: center;
        }

        .ai-option:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .ai-option a {
            color: #fff;
            text-decoration: none;
            display: block;
        }

        .ai-container h1 {
            text-align: center;
            color: #2c3e50;
            font-size: clamp(24px, 5vw, 28px);
            margin-bottom: 15px;
        }

        .dark-mode .ai-container h1 {
            color: #60a5fa;
        }

        .ai-container p {
            text-align: center;
            color: #5c6b7a;
            margin-bottom: 20px;
            font-size: clamp(15px, 3vw, 17px);
        }

        .dark-mode .ai-container p {
            color: #a0aec0;
        }

        .chat-box {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e0e4e8;
            border-radius: 10px;
            padding: 20px;
            background: #f9fafb;
            margin-bottom: 20px;
            scrollbar-width: thin;
            max-height: 60vh;
        }

        .dark-mode .chat-box {
            background: #4a5568;
            border-color: #718096;
        }

        .message {
            margin: 12px 0;
            padding: 12px 16px;
            border-radius: 10px;
            max-width: 75%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease-out;
            line-height: 1.6;
            position: relative;
        }

        .message::before {
            content: "✔";
            position: absolute;
            right: 10px;
            bottom: 5px;
            color: #25d366;
            font-size: 12px;
            opacity: 0.7;
        }

        .user-message {
            background: #007bff;
            color: #fff;
            margin-left: auto;
            box-shadow: 0 3px 6px rgba(0, 123, 255, 0.2);
        }

        .ai-message {
            background: #e9ecef;
            color: #2c3e50;
            margin-right: auto;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.05);
        }

        .dark-mode .ai-message {
            background: #718096;
            color: #e0e0e0;
        }

        .input-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e4e8;
            border-radius: 10px;
            resize: none;
            height: 100px;
            font-size: 16px;
        }

        .dark-mode textarea {
            background: #4a5568;
            border-color: #718096;
            color: #e0e0e0;
        }

        textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 6px rgba(0, 123, 255, 0.4);
            outline: none;
        }

        .file-input {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
        }

        button, input[type="file"] {
            padding: 12px 20px;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            transition: background 0.3s, transform 0.2s;
            min-width: 120px;
        }

        input[type="file"] {
            background: none;
            color: #007bff;
            padding: 12px;
        }

        .dark-mode input[type="file"] {
            color: #60a5fa;
        }

        button:hover, input[type="file"]:hover:not(:disabled) {
            background: #0056b3;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #c0c4cc;
            cursor: not-allowed;
        }

        .loading {
            position: relative;
            pointer-events: none;
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .preview-image {
            max-width: 100%;
            margin-top: 12px;
            display: none;
            border-radius: 10px;
        }

        .copy-share-btn {
            margin-top: 10px;
            padding: 8px 14px;
            background: #28a745;
            font-size: 14px;
            border-radius: 8px;
        }

        .copy-share-btn:hover {
            background: #218838;
        }

        .back-button {
            background: #6c757d;
            padding: 10px 18px;
            font-size: 15px;
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
        }

        .back-button:hover {
            background: #5a6268;
        }

        .sign-out-button {
            background: #dc3545;
            padding: 10px 18px;
            font-size: 15px;
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .sign-out-button:hover {
            background: #c82333;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 100px;
            padding: 10px 18px;
            background: #6c757d;
            font-size: 15px;
            border-radius: 8px;
            cursor: pointer;
        }

        .theme-toggle:hover {
            background: #5a6268;
        }

        .hidden {
            display: none;
        }

        footer {
            text-align: right;
            font-size: clamp(13px, 2vw, 15px);
            color: #6c757d;
            padding-top: 15px;
        }

        .dark-mode footer {
            color: #a0aec0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .subject-grid {
                grid-template-columns: 1fr;
            }

            .auth-container h1 {
                font-size: clamp(24px, 4vw, 28px);
            }

            .auth-container input, .auth-container button {
                font-size: 15px;
                padding: 12px;
            }

            .ai-options {
                gap: 12px;
            }

            .ai-option {
                font-size: 15px;
                padding: 12px;
            }

            .chat-box {
                max-height: 50vh;
            }

            textarea {
                height: 80px;
                font-size: 15px;
            }

            button, input[type="file"] {
                padding: 10px 14px;
                font-size: 14px;
                min-width: 100px;
            }

            .file-input {
                gap: 10px;
            }

            .message {
                max-width: 85%;
                padding: 10px 14px;
            }

            .theme-toggle {
                right: 80px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .auth-container {
                padding: 20px;
            }

            .subject-card h2 {
                font-size: 20px;
            }

            .ai-list-container h1 {
                font-size: clamp(26px, 5vw, 30px);
            }

            .ai-container h1 {
                font-size: clamp(20px, 5vw, 24px);
            }

            .chat-box {
                max-height: 45vh;
            }

            .theme-toggle {
                top: 60px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Screen -->
    <div class="container auth-container" id="authScreen">
        <img src="https://hugo_wong.pyscriptapps.com/ict-ai-v4-3/latest/logo.jpg" alt="Platform Logo" style="margin-bottom: 15px; border-radius: 10px; max-width: 80px;">
        <h1>Multi-Subject AI Learning</h1>
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button id="sign-in-button">Sign In</button>
        <button id="register-button">Register</button>
        <div id="auth-error"></div>
        <footer>Designed by Hugo Wong<br>Copyright © 2025 Wong. All rights reserved.</footer>
    </div>

    <!-- Cover Page (Subject List) -->
    <div class="container cover-container hidden" id="coverScreen">
        <button class="sign-out-button" id="sign-out-button">Sign Out</button>
        <button class="theme-toggle" onclick="toggleTheme()">Toggle Theme</button>
        <img src="https://hugo_wong.pyscriptapps.com/ict-ai-v4-3/latest/logo.jpg" alt="Platform Logo" style="margin-bottom: 15px; border-radius: 10px; max-width: 80px;">
        <h1>Choose a Subject</h1>
        <div class="subject-grid">
            <div class="subject-card" onclick="showAIList('English')"><h2>English</h2></div>
            <div class="subject-card" onclick="showAIList('Math')"><h2>Math</h2></div>
            <div class="subject-card" onclick="showAIList('Physics')"><h2>Physics</h2></div>
            <div class="subject-card" onclick="showAIList('Biology')"><h2>Biology</h2></div>
            <div class="subject-card" onclick="showAIList('ICT')"><h2>ICT</h2></div>
        </div>
        <footer>Designed by Hugo Wong<br>Copyright © 2025 Wong. All rights reserved.</footer>
    </div>

    <!-- Subject AI List Page -->
    <div class="container ai-list-container hidden" id="aiListScreen">
        <button class="back-button" onclick="showCover()">Back to Subjects</button>
        <button class="sign-out-button" id="sign-out-button-ai-list">Sign Out</button>
        <button class="theme-toggle" onclick="toggleTheme()">Toggle Theme</button>
        <img src="https://hugo_wong.pyscriptapps.com/ict-ai-v4-3/latest/logo.jpg" alt="Platform Logo" style="margin-bottom: 15px; border-radius: 10px; max-width: 80px;">
        <h1 id="aiListHeader">[Subject] AI Tools</h1>
        <div class="ai-options" id="aiOptions"></div>
        <footer>Designed by Hugo Wong<br>Copyright © 2025 Wong. All rights reserved.</footer>
    </div>

    <!-- Ask AI Interface -->
    <div class="container ai-container hidden" id="askAIInterface">
        <button class="back-button" onclick="showAIList(currentSubject)">Back to AI Tools</button>
        <button class="sign-out-button" id="sign-out-button-ask-ai">Sign Out</button>
        <button class="theme-toggle" onclick="toggleTheme()">Toggle Theme</button>
        <h1 id="askAIHeader">Ask AI - [Subject]</h1>
        <p>Ask me anything about [Subject]!</p>
        <div class="chat-box" id="askAIChatBox">
            <div class="message ai-message">Hello! How can I assist you today?</div>
        </div>
        <div class="input-area">
            <textarea id="askAIInput" placeholder="Type your question here..."></textarea>
            <div class="file-input">
                <input type="file" id="askAIPhotoInput" accept="image/*" onchange="previewImage('askAI')">
                <button onclick="pasteImage('askAI')">Paste Image</button>
                <img id="askAIImagePreview" class="preview-image" alt="Image preview">
                <button id="askAISendBtn" onclick="sendMessage('askAI')">Send</button>
            </div>
        </div>
        <footer>Designed by Hugo Wong<br>Copyright © 2025 Wong. All rights reserved.</footer>
    </div>

    <!-- Dictionary AI Interface -->
    <div class="container ai-container hidden" id="dictionaryAIInterface">
        <button class="back-button" onclick="showAIList(currentSubject)">Back to AI Tools</button>
        <button class="sign-out-button" id="sign-out-button-dictionary-ai">Sign Out</button>
        <button class="theme-toggle" onclick="toggleTheme()">dark mode</button>
        <h1 id="dictionaryAIHeader">Dictionary AI - [Subject]</h1>
        <p>Enter a term to get a detailed explanation.</p>
        <div class="chat-box" id="dictionaryAIChatBox">
            <div class="message ai-message">Hello! Enter a term to learn more.</div>
        </div>
        <div class="input-area">
            <textarea id="dictionaryAIInput" placeholder="Enter word or phrase..."></textarea>
            <div class="file-input">
                <button id="dictionaryAISendBtn" onclick="sendMessage('dictionaryAI')">Send</button>
            </div>
        </div>
        <footer>Designed by Hugo Wong<br>Copyright © 2025 Wong. All rights reserved.</footer>
    </div>

    <!-- Guide Learning Interface -->
    <div class="container ai-container hidden" id="guideLearningInterface">
        <button class="back-button" onclick="showAIList(currentSubject)">Back to AI Tools</button>
        <button class="sign-out-button" id="sign-out-button-guide-learning">Sign Out</button>
        <button class="theme-toggle" onclick="toggleTheme()">Toggle Theme</button>
        <h1 id="guideLearningHeader">Guide Learning - [Subject]</h1>
        <p>Ask a question, and I'll guide you to the answer!</p>
        <div class="chat-box" id="guideLearningChatBox">
            <div class="message ai-message">Hello! Ask a question to get started.</div>
        </div>
        <div class="input-area">
            <textarea id="guideLearningInput" placeholder="Type your question here..."></textarea>
            <div class="file-input">
                <input type="file" id="guideLearningPhotoInput" accept="image/*" onchange="previewImage('guideLearning')">
                <button onclick="pasteImage('guideLearning')">Paste Image</button>
                <img id="guideLearningImagePreview" class="preview-image" alt="Image preview">
                <button id="guideLearningSendBtn" onclick="sendMessage('guideLearning')">Send</button>
            </div>
        </div>
        <footer>Designed by Hugo Wong<br>Copyright © 2025 Wong. All rights reserved.</footer>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAXCSDsibC9yTJed3cbRjmWmOIMv1A2cr8",
            authDomain: "login-system-9c566.firebaseapp.com",
            projectId: "login-system-9c566",
            storageBucket: "login-system-9c566.firebasestorage.app",
            messagingSenderId: "547074181663",
            appId: "1:547074181663:web:6e3afd6c7c1ec6ae43232a",
            measurementId: "G-09M3C3D6PT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // DOM Elements
        const authScreen = document.getElementById('authScreen');
        const coverScreen = document.getElementById('coverScreen');
        const aiListScreen = document.getElementById('aiListScreen');
        const askAIInterface = document.getElementById('askAIInterface');
        const dictionaryAIInterface = document.getElementById('dictionaryAIInterface');
        const guideLearningInterface = document.getElementById('guideLearningInterface');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const signInButton = document.getElementById('sign-in-button');
        const registerButton = document.getElementById('register-button');
        const signOutButtons = document.querySelectorAll('.sign-out-button');
        const authError = document.getElementById('auth-error');

        // Firebase Authentication
        onAuthStateChanged(auth, (

user) => {
            if (user) {
                authScreen.classList.add('hidden');
                coverScreen.classList.remove('hidden');
                signOutButtons.forEach(btn => btn.classList.remove('hidden'));
                console.log('User signed in:', user.email);
            } else {
                authScreen.classList.remove('hidden');
                coverScreen.classList.add('hidden');
                aiListScreen.classList.add('hidden');
                askAIInterface.classList.add('hidden');
                dictionaryAIInterface.classList.add('hidden');
                guideLearningInterface.classList.add('hidden');
                signOutButtons.forEach(btn => btn.classList.add('hidden'));
                authError.textContent = '';
                console.log('No user signed in');
            }
        });

        signInButton.addEventListener('click', () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            if (!email || !password) {
                authError.textContent = 'Please enter both email and password.';
                return;
            }
            signInWithEmailAndPassword(auth, email, password)
                .then(() => {
                    emailInput.value = '';
                    passwordInput.value = '';
                    authError.textContent = '';
                })
                .catch((error) => {
                    authError.textContent = `Error: ${error.message}`;
                });
        });

        registerButton.addEventListener('click', () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            if (!email || !password) {
                authError.textContent = 'Please enter both email and password.';
                return;
            }
            createUserWithEmailAndPassword(auth, email, password)
                .then(() => {
                    emailInput.value = '';
                    passwordInput.value = '';
                    authError.textContent = '';
                })
                .catch((error) => {
                    authError.textContent = `Error: ${error.message}`;
                });
        });

        signOutButtons.forEach(btn => btn.addEventListener('click', () => {
            signOut(auth).then(() => console.log('Signed out')).catch((error) => {
                authError.textContent = `Error: ${error.message}`;
            });
        }));
    </script>

    <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
    <script>
        // Grok API Configuration
        const API_URL = "https://api.x.ai/v1/chat/completions";
        const apiKey = process.env.apikey;
        const MODEL = "grok-2-latest";
// Subject-Specific System Prompts
const SUBJECTS = {
    'English': {
        ask: `
You are an AI Learning Assistant designed for Hong Kong DSE English students. Provide clear, concise, and engaging answers to enhance language proficiency in reading, writing, speaking, and listening. Focus on grammar, vocabulary, text analysis, and composition skills. Use Markdown formatting (e.g., **bold**, *italic*, ### for headings) for clarity and structure. Include practical examples (e.g., sample sentences, writing prompts) to illustrate concepts. Avoid complex linguistic jargon unless explained in simple terms. For advanced topics (e.g., stylistic devices, essay structure), provide explanations in both English and Cantonese (using traditional Chinese characters) to support comprehension. If an image is provided, analyze its content (e.g., text excerpts, advertisements, poems) and any extracted text (via OCR) if relevant to English, then respond with insights or corrections. If the question, image, or extracted text is unclear, ask for clarification to ensure relevance.
        `,
        dict: `
You are a Dictionary AI designed for Hong Kong DSE English students. Provide detailed explanations of English-related terms or phrases (e.g., idioms, literary terms, grammar rules) entered by the user. Use Markdown formatting (e.g., **bold**, *italic*, ### for headings) for clarity. For each term, include:
- A clear definition in English, emphasizing its role in language use.
- For complex terms (e.g., metaphor, subjunctive mood), an additional explanation in Cantonese (using traditional Chinese characters).
- Sample usage (e.g., sentences, short paragraphs, or dialogues) showing the term in context.
- A breakdown of how the example enhances communication or writing.
Keep responses engaging, beginner-friendly, and focused on practical language skills. If the term is unclear or not English-related, ask for clarification or suggest relevant English terms.
        `,
        guide: `
You are a Guide Learning AI designed for Hong Kong DSE English students. Instead of giving direct answers, guide the user to improve their language skills by simplifying their question and offering tailored hints. Use Markdown formatting (e.g., **bold**, *italic*, ### for headings) for clarity. For each question:
- Restate the user's question in both English and Traditional Chinese (繁體中文) to ensure understanding.
- Break the question into smaller parts (e.g., grammar, vocabulary, or structure).
- Provide hints or guiding questions to encourage critical thinking (e.g., "What tense fits this context?" or "Can you identify the tone of this text?").
- If an image is provided, analyze its content (e.g., text excerpts, writing samples) and any extracted text (via OCR) if relevant to English, then incorporate this into the guidance.
- Keep responses encouraging, beginner-friendly, and focused on building confidence in language use.
If the question, image, or extracted text is unclear, ask for clarification.
        `
    },
    'Math': {
        ask: `
You are an AI Learning Assistant designed for Hong Kong DSE Mathematics students. Provide clear, concise, and structured answers to deepen understanding of mathematical concepts, problem-solving techniques, and quantitative reasoning. Focus on topics like algebra, geometry, calculus, and statistics. Use Markdown formatting (e.g., **bold**, *italic*, ### for headings) to organize explanations and highlight key steps. Include step-by-step examples (e.g., solving equations, graphing functions) to clarify processes. Avoid abstract mathematical jargon unless explained simply. For complex topics (e.g., derivatives, probability distributions), provide explanations in both English and Cantonese (using traditional Chinese characters) to aid comprehension. If an image is provided, analyze its content (e.g., equations, graphs, geometric figures) and any extracted text (via OCR) if relevant to Mathematics, then respond with detailed solutions or interpretations. If the question, image, or extracted text is unclear, ask for clarification.
        `,
        dict: `
You are a Dictionary AI designed for Hong Kong DSE Mathematics students. Provide detailed explanations of Mathematics-related terms or concepts (e.g., polynomial, sine, standard deviation) entered by the user. Use Markdown formatting (e.g., **bold**, *italic*, ### for headings) for clarity. For each term, include:
- A clear definition in English, emphasizing its mathematical significance.
- For complex concepts (e.g., matrices, logarithms), an additional explanation in Cantonese (using traditional Chinese characters).
- Sample usage (e.g., a solved problem or graph) demonstrating the term’s application.
- A step-by-step explanation of the example to reinforce understanding.
Keep responses structured, beginner-friendly, and focused on practical problem-solving. If the term is unclear or not Mathematics-related, ask for clarification or suggest relevant Mathematics terms.
        `,
        guide: `
You are a Guide Learning AI designed for Hong Kong DSE Mathematics students. Instead of giving direct answers, guide the user to solve mathematical problems by simplifying the question and offering strategic hints. Use Markdown formatting (e.g., **bold**, *italic*, ### for headings) for clarity. For each question:
- Restate the user’s question in both English and Traditional Chinese (繁體中文) to ensure understanding.
- Break the question into smaller, logical steps (e.g., identifying variables, choosing a formula).
- Provide hints or guiding questions to lead the user to the solution (e.g., "What formula applies to this shape?" or "Can you simplify this expression first?").
- If an image is provided, analyze its content (e.g., equations, graphs) and any extracted text (via OCR) if relevant to Mathematics, then incorporate this into the guidance.
- Keep responses encouraging, beginner-friendly, and focused on building problem-solving skills.
If the question, image, or extracted text is unclear, ask for clarification.
        `
    },
    'Physics': {
        ask: `
You are an AI Learning Assistant designed for Hong Kong DSE Physics students. Provide clear, concise, and visually-oriented answers to deepen understanding of physical laws, phenomena, and experimental methods. Focus on topics like mechanics, electricity, waves, and modern physics. Use Markdown formatting (e.g., **bold**, *italic*, ### for headings) to structure explanations and highlight key principles. Include practical examples (e.g., calculations, experimental setups) to connect theory to real-world applications. Avoid technical jargon unless explained simply. For complex topics (e.g., electromagnetic induction, nuclear physics), provide explanations in both English and Cantonese (using traditional Chinese characters) to aid comprehension. If an image is provided, analyze its content (e.g., circuit diagrams, motion graphs, experimental setups) and any extracted text (via OCR) if relevant to Physics, then respond with detailed analysis or solutions. If the question, image, or extracted text is unclear, ask for clarification.
        `,
        dict: `
You are a Dictionary AI designed for Hong Kong DSE Physics students. Provide detailed explanations of Physics-related terms or concepts (e.g., momentum, capacitance, diffraction) entered by the user. Use Markdown formatting (e.g., **bold**, *italic*, ### for headings) for clarity. For each term, include:
- A clear definition in English, emphasizing its physical significance.
- For complex concepts (e.g., quantum tunneling, angular momentum), an additional explanation in Cantonese (using traditional Chinese characters).
- Sample usage (e.g., a calculation, diagram, or experimental context) demonstrating the term’s application.
- A detailed explanation of the example to connect it to physical principles.
Keep responses clear, beginner-friendly, and focused on real-world relevance. If the term is unclear or not Physics-related, ask for clarification or suggest relevant Physics terms.
        `,
        guide: `
You are a Guide Learning AI designed for Hong Kong DSE Physics students. Instead of giving direct answers, guide the user to understand physical concepts or solve problems by simplifying the question and offering intuitive hints. Use Markdown formatting (e.g., **bold**, *italic*, ### for headings) for clarity. For each question:
- Restate the user’s question in both English and Traditional Chinese (繁體中文) to ensure understanding.
- Break the question into smaller parts (e.g., identifying forces, applying a law).
- Provide hints or guiding questions to lead the user to the solution (e.g., "What forces act on this object?" or "How does energy conservation apply here?").
- If an image is provided, analyze its content (e.g., circuit diagrams, motion graphs) and any extracted text (via OCR) if relevant to Physics, then incorporate this into the guidance.
- Keep responses engaging, beginner-friendly, and focused on fostering curiosity about physical phenomena.
If the question, image, or extracted text is unclear, ask for clarification.
        `
    },
    'Biology': {
        ask: `
You are an AI Learning Assistant designed for Hong Kong DSE Biology students. Provide clear, concise, and process-oriented answers to deepen understanding of biological systems, processes, and their applications. Focus on topics like cell biology, genetics, ecology, and human physiology. Use Markdown formatting (e.g., **bold**, *italic*, ### for headings) to structure explanations and highlight key processes. Include practical examples (e.g., biological processes, experimental observations) to connect concepts to real-life contexts like health or the environment. Avoid scientific jargon unless explained simply. For complex topics (e.g., gene expression, ecological succession), provide explanations in both English and Cantonese (using traditional Chinese characters) to aid comprehension. If an image is provided, analyze its content (e.g., cell diagrams, food webs, anatomical drawings) and any extracted text (via OCR) if relevant to Biology, then respond with detailed analysis or explanations. If the question, image, or extracted text is unclear, ask for clarification.
        `,
        dict: `
You are a Dictionary AI designed for Hong Kong DSE Biology students. Provide detailed explanations of Biology-related terms or concepts (e.g., photosynthesis, mutation, biodiversity) entered by the user. Use Markdown formatting (e.g., **bold**, *italic*, ### for headings) for clarity. For each term, include:
- A clear definition in English, emphasizing its biological role.
- For complex concepts (e.g., meiosis, neural signaling), an additional explanation in Cantonese (using traditional Chinese characters).
- Sample usage (e.g., a process description, diagram, or experimental context) demonstrating the term’s application.
- A detailed explanation of the example to connect it to biological principles.
Keep responses clear, beginner-friendly, and focused on real-life biological applications. If the term is unclear or not Biology-related, ask for clarification or suggest relevant Biology terms.
        `,
        guide: `
You are a Guide Learning AI designed for Hong Kong DSE Biology students. Instead of giving direct answers, guide the user to understand biological concepts or answer questions by simplifying the question and offering intuitive hints. Use Markdown formatting (e.g., **bold**, *italic*, ### for headings) for clarity. For each question:
- Restate the user’s question in both English and Traditional Chinese (繁體中文) to ensure understanding.
- Break the question into smaller parts (e.g., identifying a process, analyzing a structure).
- Provide hints or guiding questions to lead the user to the solution (e.g., "What are the stages of this process?" or "How does this structure function in the body?").
- If an image is provided, analyze its content (e.g., cell diagrams, food webs) and any extracted text (via OCR) if relevant to Biology, then incorporate this into the guidance.
- Keep responses engaging, beginner-friendly, and focused on fostering curiosity about living systems.
If the question, image, or extracted text is unclear, ask for clarification.
        `
    },
    'ICT': {
        ask: `
You are an AI Learning Assistant designed for Hong Kong DSE Information and Communication Technology students. Provide clear, concise, and practical answers to deepen understanding of technology, coding, and digital systems. Focus on topics like programming, networking, databases, and cybersecurity. Use Markdown formatting (e.g., **bold**, *italic*, ### for headings) to structure explanations and highlight key technical points. Include hands-on examples (e.g., code snippets, network configurations) to illustrate concepts. Avoid technical jargon unless explained simply. For complex topics (e.g., object-oriented programming, encryption), provide explanations in both English and Cantonese (using traditional Chinese characters) to aid comprehension. If an image is provided, analyze its content (e.g., code screenshots, network diagrams, UI designs) and any extracted text (via OCR) if relevant to ICT, then respond with detailed analysis or solutions. If the question, image, or extracted text is unclear, ask for clarification.
        `,
        dict: `
You are a Dictionary AI designed for Hong Kong DSE Information and Communication Technology students. Provide detailed explanations of ICT-related terms or concepts (e.g., algorithm, firewall, SQL query) entered by the user. Use Markdown formatting (e.g., **bold**, *italic*, ### for headings) for clarity. For each term, include:
- A clear definition in English, emphasizing its technical significance.
- For complex concepts (e.g., machine learning, blockchain), an additional explanation in Cantonese (using traditional Chinese characters).
- Sample usage (e.g., a code snippet, network setup, or application scenario) demonstrating the term’s practical use.
- A detailed explanation of the example to clarify its functionality.
Keep responses practical, beginner-friendly, and focused on real-world ICT applications. If the term is unclear or not ICT-related, ask for clarification or suggest relevant ICT terms.
        `,
        guide: `
You are a Guide Learning AI designed for Hong Kong DSE Information and Communication Technology students. Instead of giving direct answers, guide the user to understand technical concepts or solve problems by simplifying the question and offering practical hints. Use Markdown formatting (e.g., **bold**, *italic*, ### for headings) for clarity. For each question:
- Restate the user’s question in both English and Traditional Chinese (繁體中文) to ensure understanding.
- Break the question into smaller parts (e.g., identifying a coding logic, understanding a network component).
- Provide hints or guiding questions to lead the user to the solution (e.g., "What does this code loop do?" or "Which protocol suits this network?").
- If an image is provided, analyze its content (e.g., code screenshots, network diagrams) and any extracted text (via OCR) if relevant to ICT, then incorporate this into the guidance.
- Keep responses engaging, beginner-friendly, and focused on building technical confidence.
Unless the question, image, or extracted text is unclear, ask for clarification.
        `
    }
};
        let currentSubject = '';
        let histories = {
            'askAI': [],
            'dictionaryAI': [],
            'guideLearning': []
        };

        // Theme Toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }

        // Load Theme Preference
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }

        // Navigation Functions
        function showCover() {
            coverScreen.classList.remove('hidden');
            aiListScreen.classList.add('hidden');
            askAIInterface.classList.add('hidden');
            dictionaryAIInterface.classList.add('hidden');
            guideLearningInterface.classList.add('hidden');
        }

        function showAIList(subject) {
            currentSubject = subject;
            coverScreen.classList.add('hidden');
            aiListScreen.classList.remove('hidden');
            askAIInterface.classList.add('hidden');
            dictionaryAIInterface.classList.add('hidden');
            guideLearningInterface.classList.add('hidden');

            document.getElementById('aiListHeader').textContent = `${subject} AI Tools`;
            const aiOptions = document.getElementById('aiOptions');
            aiOptions.innerHTML = `
                <div class="ai-option" onclick="showAI('${subject}', 'askAI')">Ask AI</div>
                <div class="ai-option" onclick="showAI('${subject}', 'dictionaryAI')">Dictionary AI</div>
                <div class="ai-option" onclick="showAI('${subject}', 'guideLearning')">Guide Learning</div>
                ${subject === 'English' ? `
                    <div class="ai-option"><a href="https://hugo_wong.pyscriptapps.com/eng-vocab-ai-v3/latest/" target="_blank">Vocabulary Generator</a></div>
                    <div class="ai-option"><a href="https://hugo_wong.pyscriptapps.com/ai-vocab-quiz/latest/" target="_blank">Vocabulary Quiz</a></div>
                ` : ''}
            `;
        }

        function showAI(subject, type) {
            currentSubject = subject;
            coverScreen.classList.add('hidden');
            aiListScreen.classList.add('hidden');
            document.getElementById(type + 'Interface').classList.remove('hidden');

            const headers = {
                askAI: document.getElementById('askAIHeader'),
                dictionaryAI: document.getElementById('dictionaryAIHeader'),
                guideLearning: document.getElementById('guideLearningHeader')
            };
            headers[type].textContent = `${type.replace('AI', ' ').replace('guideLearning', 'Guide Learning')} - ${subject}`;
            const systemPrompt = SUBJECTS[subject][type.replace('Interface', '')];
            histories[type] = [{ role: "system", content: systemPrompt }];
            document.getElementById(type + 'ChatBox').innerHTML = `<div class="message ai-message">Hello! How can I assist you with ${subject} today?</div>`;
            document.getElementById(type + 'Input').focus();
        }

        // Image Handling
        function previewImage(type) {
            const preview = document.getElementById(`${type}ImagePreview`);
            const file = document.getElementById(`${type}PhotoInput`).files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        }

        function pasteImage(type) {
            navigator.clipboard.read().then(async (items) => {
                for (const item of items) {
                    if (item.types.includes('image/png') || item.types.includes('image/jpeg')) {
                        const blob = await item.getType(item.types.find(t => t.startsWith('image/')));
                        const preview = document.getElementById(`${type}ImagePreview`);
                        const input = document.getElementById(`${type}PhotoInput`);
                        const file = new File([blob], 'pasted-image.png', { type: blob.type });
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        input.files = dataTransfer.files;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            preview.src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                        return;
                    }
                }
                alert('No image in clipboard!');
            }).catch(() => alert('Failed to paste image.'));
        }

        // OCR for Image Text Extraction
        async function performOCR(file) {
            const { createWorker } = Tesseract;
            const worker = await createWorker('eng');
            const { data: { text } } = await worker.recognize(file);
            await worker.terminate();
            return text;
        }

        // Message Sending
        async function sendMessage(type) {
            const input = document.getElementById(`${type}Input`);
            const fileInput = document.getElementById(`${type}PhotoInput`);
            const preview = document.getElementById(`${type}ImagePreview`);
            const sendBtn = document.getElementById(`${type}SendBtn`);
            const chatBox = document.getElementById(`${type}ChatBox`);

            const question = input.value.trim();
            const file = fileInput?.files[0];
            if (!question && !file) {
                addMessage(type, 'Please enter a question or upload an image!', false);
                return;
            }

            let userContent = question;
            let messageContent = question || `Analyze this ${currentSubject}-related image.`;

            if (file) {
                userContent += `<br><img src="${preview.src}" style="max-width: 100%;">`;
                const extractedText = await performOCR(file);
                messageContent = `${question || `Analyze this ${currentSubject}-related image.`}\n\n**Embedded Text:**\n${extractedText}`;
            }

            addMessage(type, userContent, true);
            input.value = '';
            if (fileInput) fileInput.value = '';
            if (preview) preview.style.display = 'none';
            sendBtn.disabled = true;
            sendBtn.classList.add('loading');

            try {
                await sendRequest(type, messageContent);
            } catch (error) {
                addMessage(type, `Error: ${error.message}`, false);
                console.error('Error:', error);
            } finally {
                sendBtn.disabled = false;
                sendBtn.classList.remove('loading');
            }
        }

        async function sendRequest(type, messageContent) {
            histories[type].push({ role: "user", content: messageContent });
            // Filter out messages with empty content to avoid API errors
            const validMessages = histories[type].filter(msg => msg.content && msg.content.trim() !== '');
            if (validMessages.length === 0) {
                throw new Error('No valid messages to send.');
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: validMessages,
                        model: MODEL,
                        stream: false,
                        temperature: 0
                    })
                });

                const responseText = await response.text();
                if (!response.ok) {
                    console.error('API Response:', {
                        status: response.status,
                        statusText: response.statusText,
                        body: responseText
                    });
                    throw new Error(`API failed: ${response.status} - ${responseText}`);
                }

                const data = JSON.parse(responseText);
                const aiResponse = data.choices[0]?.message?.content || "No response";
                histories[type].push({ role: "assistant", content: aiResponse });
                addMessage(type, formatMarkdown(aiResponse), false);
                document.getElementById(`${type}ChatBox`).scrollTop = document.getElementById(`${type}ChatBox`).scrollHeight;
            } catch (error) {
                console.error('Request Error:', error);
                throw error;
            }
        }

        function addMessage(type, content, isUser) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', isUser ? 'user-message' : 'ai-message');
            messageDiv.innerHTML = content;

            if (!isUser) {
                const buttonDiv = document.createElement('div');
                const copyBtn = document.createElement('button');
                copyBtn.classList.add('copy-share-btn');
                copyBtn.textContent = 'Copy/Share';
                copyBtn.onclick = () => copyShareMessage(content);
                buttonDiv.appendChild(copyBtn);
                messageDiv.appendChild(buttonDiv);
            }

            document.getElementById(`${type}ChatBox`).appendChild(messageDiv);
            document.getElementById(`${type}ChatBox`).scrollTop = document.getElementById(`${type}ChatBox`).scrollHeight;
        }

        function copyShareMessage(content) {
            const plainText = content.replace(/<[^>]+>/g, '');
            if (navigator.share) {
                navigator.share({ title: 'AI Response', text: plainText }).catch(() => copyToClipboard(plainText));
            } else {
                copyToClipboard(plainText);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => alert('Copied!')).catch(() => alert('Copy failed.'));
        }

        function formatMarkdown(text) {
            let formatted = text.replace(/^#+ (.*)$/gm, '<h6>$1</h6>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/\*(.*?)\*/g, '<i>$1</i>').replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>').replace(/^- (.*)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>').replace(/(?<!<\/h[1-6]>)\n/g, '<br>');
            return formatted;
        }

        document.addEventListener('paste', (e) => {
            if (!askAIInterface.classList.contains('hidden')) handlePaste(e, 'askAI');
            else if (!guideLearningInterface.classList.contains('hidden')) handlePaste(e, 'guideLearning');
        });

        function handlePaste(e, type) {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const blob = items[i].getAsFile();
                    pasteImage(type);
                    break;
                }
            }
        }
    </script>
</body>
</html>